import '../../domain/entities/domino_tile.dart';
import '../../domain/entities/player.dart';

/// ุฎุฏูุฉ ูุฅุฏุงุฑุฉ ููุงุนุฏ ูุนุจุฉ ุงูุฏููููู
class GameRulesService {
  /// ุงูุญุตูู ุนูู ููุงุนุฏ ุงููุนุจุฉ ูู String
  static const String gameRules = '''
  ๐ฒ ููุงููู ูุนุจุฉ ุงูุฏููููู ๐ฒ

  ๐น ุจุฏุงูุฉ ุงููุนุจุฉ:
  - ูุชู ุฎูุท ุฌููุน ูุทุน ุงูุฏููููู (28 ูุทุนุฉ) ููุถุนูุง ููููุจุฉ ุนูู ุงูุทุงููุฉ.
  - ูู ูุงุนุจ ูุณุญุจ 7 ูุทุน ุนุดูุงุฆูุงู (ูู ุญุงูุฉ ุงููุนุจ ุจุงุซููู).
  - ุงููุงุนุจ ุงูุฐู ูููู ุงููุทุนุฉ ุงูุฃูุจุฑ (6/6) ูุจุฏุฃ ุงููุนุจ ุจูุง.
  - ุฅุฐุง ูู ุชูู ุงููุทุนุฉ (6/6) ููุฌูุฏุฉุ ูุจุฏุฃ ุตุงุญุจ ุงููุทุนุฉ ุงูุฃูุจุฑ ุงูุชุงููุฉ.

  ๐น ุทุฑููุฉ ุงููุนุจ:
  1. ูุจุฏุฃ ุงููุงุนุจ ุงูุฃูู ุจูุถุน ุฃู ูุทุนุฉ ูุฎุชุงุฑูุง ูู ููุชุตู ุงูุทุงููุฉ.
  2. ุงูุฏูุฑ ููุชูู ููุงุนุจ ุงูุชุงูู ูู ุงุชุฌุงู ุนูุงุฑุจ ุงูุณุงุนุฉ.
  3. ุนูู ูู ูุงุนุจ ูุถุน ูุทุนุฉ ููุงุณุจุฉ ุจุญูุซ:
     โข ุชุชุทุงุจู ุฅุญุฏู ููุงูุชู ุงููุทุนุฉ ูุน ููุงูุฉ ุณูุณูุฉ ุงูุฏููููู.
     โข ุฅุฐุง ูุงูุช ุงููุทุนุฉ ุชุญุชุงุฌ ููุฏูุฑุงู (ููุจ) ูุชุชูุงุณุจุ ููุฌุจ ุชุฏููุฑูุง.
  4. ุฅุฐุง ูู ููู ูุฏู ุงููุงุนุจ ูุทุนุฉ ููุงุณุจุฉุ ูุฌุจ ุนููู ุณุญุจ ูุทุนุฉ ูู ุงููููุฉ.
  5. ุฅุฐุง ูู ุชูู ููุงู ูุทุน ูุชุจููุฉ ููุฑุณูุ ูุชู ุชุฎุทู ุฏูุฑ ุงููุงุนุจ.

  ๐น ููุงูุฉ ุงูุฌููุฉ:
  - ุชูุชูู ุงูุฌููุฉ ุนูุฏูุง:
    1. ููุนุจ ุฃุญุฏ ุงููุงุนุจูู ุขุฎุฑ ูุทุนุฉ ูุฏูู (ูููุฒ ุจุงูุฌููุฉ).
    2. ูุง ูุณุชุทูุน ุฃู ูุงุนุจ ูุนุจ ุฃู ูุทุนุฉ (ุงููุนุจุฉ ูููููุฉ).

  ๐น ุงุญุชุณุงุจ ุงูููุงุท:
  - ุนูุฏ ุงูุชูุงุก ุงูุฌููุฉุ ูุญุณุจ ูู ูุงุนุจ ูุฌููุน ุงูููุงุท ุงููุชุจููุฉ ูู ูุฏู.
  - ุงููุงุฆุฒ ุจุงูุฌููุฉ ูุณุฌู ูุฌููุน ููุงุท ุฌููุน ุงููุงุนุจูู ุงูุขุฎุฑูู.
  - ุฃูู ูู ูุตู ุฅูู 100 ููุทุฉ (ุฃู ุฃู ูุฌููุน ูุชูู ุนููู) ูููุฒ ุจุงููุจุงุฑุงุฉ.
  ''';

  /// ุชุญุฏูุฏ ุงููุงุนุจ ุงูุฐู ุณููุนุจ ุฃููุงู ุจูุงุกู ุนูู ุงููุทุน ุงูุชู ุจุญูุฒุชู
  static String determineFirstPlayer(List<Player> players) {
    // ุงูุจุญุซ ุนู ุงููุงุนุจ ุงูุฐู ูููู ุงููุทุนุฉ 6/6
    for (var player in players) {
      if (player.hand.any((tile) => tile.left == 6 && tile.right == 6)) {
        return player.id;
      }
    }

    // ุฅุฐุง ูู ุชูุฌุฏ ูุทุนุฉ 6/6ุ ูุจุญุซ ุนู ุงููุทุนุฉ ุงูุฃูุจุฑ
    int maxSum = -1;
    String firstPlayerId = players.first.id;
    
    for (var player in players) {
      for (var tile in player.hand) {
        final sum = tile.left + tile.right;
        if (sum > maxSum) {
          maxSum = sum;
          firstPlayerId = player.id;
        }
      }
    }

    return firstPlayerId;
  }

  /// ุงูุชุญูู ููุง ุฅุฐุง ูุงูุช ุงูุฌููุฉ ุงูุชูุช
  static bool isRoundOver(List<Player> players) {
    // ุฅุฐุง ูุงู ูุฏู ุฃู ูุงุนุจ 0 ูุทุนุ ุงูุชูุช ุงูุฌููุฉ
    if (players.any((player) => player.hand.isEmpty)) {
      return true;
    }
    return false;
  }

  /// ุญุณุงุจ ุงูููุงุท ููุงุนุจ
  static int calculatePlayerScore(Player player) {
    return player.hand.fold(0, (sum, tile) => sum + tile.left + tile.right);
  }

  /// ุงูุญุตูู ุนูู ููุงุนุฏ ุงููุนุจุฉ
  static String getGameRules() {
    return gameRules;
  }

  /// ุงูุชุญูู ููุง ุฅุฐุง ูุงูุช ุงููุทุนุฉ ูููู ูุนุจูุง ูู ุงูููุถุน ุงูุญุงูู
  static bool canPlayTile(DominoTile tile, List<DominoTile> boardTiles) {
    if (boardTiles.isEmpty) return true;
    
    final leftEnd = boardTiles.first.left;
    final rightEnd = boardTiles.last.right;
    
    return tile.left == leftEnd || 
           tile.right == leftEnd || 
           tile.left == rightEnd || 
           tile.right == rightEnd;
  }

  /// ุชุฏููุฑ ุงููุทุนุฉ ุฅุฐุง ูุฒู ุงูุฃูุฑ ููุนุจ
  static DominoTile rotateTileIfNeeded(DominoTile tile, int targetNumber) {
    if (tile.left == targetNumber) return tile;
    if (tile.right == targetNumber) return DominoTile(left: tile.right, right: tile.left);
    return tile;
  }
}
